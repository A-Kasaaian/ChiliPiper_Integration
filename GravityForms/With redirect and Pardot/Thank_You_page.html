<script src="https://js.chilipiper.com/marketing.js" type="text/javascript"></script>
<script>
  const tenantDomain = "[[tenant_domain]]"; // replace and remove square brackets
  const routerName = "[[router_name]]"; // replace and remove square brackets
  const pardotHandlerURL = "[[pardot_handler_url]]"; // replace and remove square brackets
  var leadValues = {};
  var uri = decodeURIComponent(document.location.search.replace(/\+/g, " "));
  var urlParams = new URLSearchParams(uri);
  var entries = urlParams.entries();
  var valid = false;
  for (pair of entries) {
    leadValues[pair[0]] = pair[1];
    if (pair[0].toLowerCase().includes("email") && pair[1].includes("@")) {
      leadValues[pair[0]] = pair[1].replaceAll(" ", "+"); // fix spaces for emails
      valid = true;
    }
  }
  if (valid) {
    // Submit to Pardot
    fetch(pardotHandlerURL, {
      method: "POST",
      dataType: "json",
      body: JSON.stringify(leadValues),
      headers: { "context-type": "application/json" },
    });
    // Call Chili Piper
    ChiliPiper.submit(tenantDomain, routerName, {
      lead: leadValues,
      map: true,
    });
    console.log(leadValues);
  }
</script>
